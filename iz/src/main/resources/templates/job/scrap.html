<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style type="text/tailwindcss">
        html {
            background-color: #f0f0f0;
        }
        /* PC에서 모바일 크기로 고정 */
        @media screen and (min-width: 769px) {
            .mobile-container {
                width: 600px;
                margin: 0 auto;
                background: white;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                min-height: 100vh;
            }
        }

        /* 모바일에서는 전체 너비 사용 */
        @media screen and (max-width: 768px) {
            .mobile-container {
                width: 100%;
                background: white;
                min-height: 100vh;
            }
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>

<div class="flex flex-col w-full mobile-container pt-8 relative">
    <div class="pt-20"><header th:replace="~{header :: header} " class="pt-4"></header></div>
    <footer th:replace="~{footer :: footer}" class="pt-4"></footer>

    <div class="p-4">
        <h1 class="text-2xl font-bold mb-6">찜 해놓은 채용공고</h1>

        <div th:if="${scrapedJobs.isEmpty()}" class="text-center text-gray-500 py-10">
            저장된 채용공고가 없습니다.
        </div>

        <div th:each="job : ${scrapedJobs}" class="bg-white shadow-md rounded-lg p-4 mb-4 relative">
            <button th:data-job-id="${job.id}"
                    class="scrap-btn absolute top-4 right-4 transition-colors duration-200 text-yellow-400">
                <i class="fas fa-star"></i>
            </button>
            <h2 class="text-lg font-semibold mb-2" th:text="${job.companyName}">🔹 기업명</h2>
            <p class="text-gray-600" th:text="${job.title}">채용 제목</p>
            <div class="text-gray-500 text-sm space-y-1">
                <div th:text="${job.locationName}">지역</div>
                <div th:text="${job.experienceMax == 0 and job.experienceMin == 0} ? '신입'
                    : (${job.experienceMax == job.experienceMin} ? '경력 ' + ${job.experienceMax} + '년'
                    : '경력 ' + (${job.experienceMax} >= ${job.experienceMin} ? ${job.experienceMin} + '~' + ${job.experienceMax}
                    : ${job.experienceMax} + '~' + ${job.experienceMin}) + '년')">경력</div>
                <div>마감일 <span th:text="${job.expirationTimestamp}" class="timestamp"></span></div>
            </div>
            <a th:href="${job.url}" target="_blank"
               class="mt-2 inline-block text-blue-600 hover:text-blue-800 text-sm">
                상세보기
            </a>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $('.scrap-btn').click(function(e) {
            e.preventDefault();
            const $btn = $(this);
            const jobId = $btn.data('job-id');

            $.ajax({
                url: '/job/scrap/' + jobId,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        if (!response.isScraped) {
                            // 스크랩 해제된 경우 해당 요소 제거
                            $btn.closest('.bg-white').remove();

                            // 목록이 비어있으면 메시지 표시
                            if ($('.bg-white').length === 0) {
                                $('.p-4').append(
                                    '<div class="text-center text-gray-500 py-10">' +
                                    '저장된 채용공고가 없습니다.' +
                                    '</div>'
                                );
                            }
                        }
                    } else {
                        alert('스크랩 처리 중 오류가 발생했습니다.');
                    }
                },
                error: function() {
                    alert('서버 통신 중 오류가 발생했습니다.');
                }
            });
        });

        // Format timestamps
        const timestampElements = document.querySelectorAll('.timestamp');
        timestampElements.forEach(element => {
            const timestamp = parseFloat(element.textContent);
            if (!isNaN(timestamp)) {
                element.textContent = formatTimestamp(timestamp);
            }
        });

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000); // Unix timestamp를 밀리초로 변환
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    });
</script>

</body>
</html>
